name: Automated ML Pipeline

on:
  schedule:
    # Run every 15 days at 2 AM UTC
    - cron: '0 2 */15 * *'
  workflow_dispatch:  # Allow manual trigger
    inputs:
      force_retrain:
        description: 'Force model retraining even without new data'
        required: false
        default: 'false'

jobs:
  pipeline:
    runs-on: ubuntu-latest
    timeout-minutes: 120
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
      
      - name: Set up Python 3.10
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Create .env file
        run: |
          echo "FRED_API_KEY=${{ secrets.FRED_API_KEY }}" >> .env
          echo "NOTIFICATION_EMAIL=${{ secrets.NOTIFICATION_EMAIL }}" >> .env
          echo "SENDER_EMAIL=${{ secrets.SENDER_EMAIL }}" >> .env
          echo "SENDER_PASSWORD=${{ secrets.SENDER_PASSWORD }}" >> .env
          echo "SMTP_SERVER=smtp.gmail.com" >> .env
          echo "SMTP_PORT=587" >> .env
          echo "ENABLE_NOTIFICATIONS=true" >> .env
      
      - name: Run ML Pipeline
        env:
          FRED_API_KEY: ${{ secrets.FRED_API_KEY }}
          NOTIFICATION_EMAIL: ${{ secrets.NOTIFICATION_EMAIL }}
          SENDER_EMAIL: ${{ secrets.SENDER_EMAIL }}
          SENDER_PASSWORD: ${{ secrets.SENDER_PASSWORD }}
        run: |
          python -c "from src.pipelines.prefect_flows import run_pipeline; run_pipeline()"
      
      - name: Upload logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: pipeline-logs-${{ github.run_id }}
          path: logs/
          retention-days: 30
      
      - name: Upload model artifacts
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: model-artifacts-${{ github.run_id }}
          path: |
            models/pppq/
            reports/pppq/
          retention-days: 90
      
      - name: Commit updated data and models
        if: success()
        run: |
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git config --global user.name "github-actions[bot]"
          
          # Check if there are changes to commit
          if [ -n "$(git status -s)" ]; then
            git add data/raw/final_consolidated_dataset.csv || true
            git add data/processed/pppq/ || true
            git add models/pppq/ || true
            git add reports/pppq/ || true
            git add logs/pipeline_state.json || true
            
            git commit -m "ðŸ¤– Auto: Pipeline update - $(date +%Y-%m-%d)"
            git push
          else
            echo "No changes to commit"
          fi
      
      - name: Send failure notification
        if: failure()
        run: |
          python -c "
          from src.pipelines.notifications import notifier
          notifier.notify_pipeline_failure(
              'PPP-Q ML Pipeline (GitHub Actions)',
              'Pipeline failed - check workflow logs',
              {'Run ID': '${{ github.run_id }}', 'Workflow': '${{ github.workflow }}'}
          )
          "
